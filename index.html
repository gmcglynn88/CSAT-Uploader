<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CSV Analytics Dashboard for Genesys Cloud</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Add Content Security Policy meta tag to prevent external script issues -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://login.mypurecloud.ie https://api.mypurecloud.ie https://raw.githubusercontent.com https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0; --selected-bg:#e3f2fd; --header-bg:#f1f8ff;
      --analytics-blue:#3b82f6; --analytics-green:#10b981; --analytics-orange:#f59e0b; --analytics-red:#ef4444;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1800px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px; color: var(--primary-color);}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    .file-upload-area{
      border:2px dashed var(--border-color);
      border-radius:8px;
      padding:40px 20px;
      text-align:center;
      background:var(--light-bg);
      cursor:pointer;
      transition:border-color .2s, background .2s;
    }
    .file-upload-area:hover{
      border-color:var(--primary-color);
      background:#f0f7f4;
    }
    .file-upload-area.has-file{
      border-color:var(--primary-color);
      background:#e9f6f0;
    }
    .upload-icon{
      font-size:48px;
      color:var(--primary-color);
      margin-bottom:12px;
    }
    .file-name{
      margin-top:12px;
      font-weight:600;
      color:var(--primary-color);
    }
    
    /* Loading spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading { display: flex; align-items: center; gap: 8px; }
    
    .help-text {
      background: #f8f9fa;
      border-left: 3px solid var(--primary-color);
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    .date-format-info {
      background: #e9f6f0;
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      padding: 12px;
      margin: 12px 0;
      font-size: 14px;
    }
    
    /* Tab Navigation */
    .tab-container {
      margin-top: 20px;
    }
    
    .tab-nav {
      display: flex;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 20px;
    }
    
    .tab-button {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .tab-button:hover {
      color: var(--primary-color);
    }
    
    .tab-button.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: #f0f7f4;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Enhanced Excel-like table with spreadsheet styling - NO WRAP */
    .excel-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13px;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      font-family: 'Segoe UI', 'Aptos', system-ui, sans-serif;
    }
    
    .excel-table th {
      background: var(--header-bg);
      border: 1px solid #c6d9f0;
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      color: #1a365d;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      min-width: 120px;
      border-bottom: 2px solid #4a8c7d;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
    }
    
    .excel-table th:hover {
      background: #e1ecff;
    }
    
    .excel-table th.sorted-asc::after {
      content: " ▲";
      font-size: 10px;
      opacity: 0.7;
    }
    
    .excel-table th.sorted-desc::after {
      content: " ▼";
      font-size: 10px;
      opacity: 0.7;
    }
    
    .excel-table td {
      border: 1px solid #e2e8f0;
      padding: 10px 10px;
      color: #2d3748;
      vertical-align: middle;
      min-height: 36px;
      transition: background-color 0.1s;
      /* NO WRAP - critical change */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
    }
    
    .excel-table tr:nth-child(even) {
      background: #f8fafc;
    }
    
    .excel-table tr:hover {
      background: #f0f9ff;
    }
    
    .excel-table td:hover {
      background: var(--selected-bg);
      overflow: visible;
      white-space: normal;
      position: relative;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
      max-width: none;
    }
    
    .table-container {
      max-height: 600px;
      overflow: auto;
      margin-top: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.05);
    }
    
    .table-stats {
      margin-top: 12px;
      font-size: 13px;
      color: #6c757d;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    
    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stat-badge {
      background: var(--primary-color);
      color: white;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }
    
    .cell-selected {
      background: #dbeafe !important;
      box-shadow: inset 0 0 0 1px #3b82f6;
    }
    
    .cell-highlight {
      background: #fef3c7 !important;
    }
    
    .cell-numeric {
      text-align: right;
      font-family: 'Segoe UI', monospace;
      color: #065f46;
    }
    
    .cell-date {
      color: #7c3aed;
    }
    
    /* Toolbar styles */
    .table-toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    
    .delimiter-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
    }
    
    .delimiter-control label {
      margin: 0;
      font-weight: normal;
      font-size: 13px;
    }
    
    .delimiter-control select {
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 4px;
    }
    
    /* Date range selector */
    .date-range-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
    }
    
    .date-range-selector label {
      margin: 0;
      font-weight: normal;
      font-size: 13px;
    }
    
    .date-range-selector input {
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 4px;
      max-width: 120px;
    }
    
    /* Search box */
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .search-box input {
      border: none;
      padding: 4px 8px;
      font-size: 13px;
      min-width: 200px;
      outline: none;
    }
    
    /* Filter indicator */
    .filter-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: #e0f2fe;
      border-radius: 4px;
      font-size: 11px;
      color: #0369a1;
      margin-left: 4px;
    }
    
    /* Empty cell styling */
    .empty-cell {
      color: #94a3b8 !important;
      font-style: italic;
    }
    
    /* Analytics Dashboard Styles */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .metric-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,.05);
    }
    
    .metric-title {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 8px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 4px;
    }
    
    .metric-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .metric-change.positive {
      color: #10b981;
    }
    
    .metric-change.negative {
      color: #ef4444;
    }
    
    .chart-container {
      height: 300px;
      margin-top: 15px;
      position: relative;
    }
    
    .analytics-section {
      margin-top: 30px;
    }
    
    .analytics-section-title {
      font-size: 18px;
      color: var(--secondary-color);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    /* Word Cloud Styles */
    .word-cloud-container {
      height: 300px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      background: #f8fafc;
      overflow: hidden;
      position: relative;
    }
    
    .word-cloud-word {
      display: inline-block;
      margin: 5px;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .word-cloud-word:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0,0,0,.1);
    }
    
    /* Score distribution */
    .score-bar {
      height: 20px;
      background: #e2e8f0;
      border-radius: 4px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    
    .score-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .score-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 13px;
    }
    
    /* Sentiment analysis */
    .sentiment-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .sentiment-positive {
      background: #dcfce7;
      color: #166534;
    }
    
    .sentiment-negative {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .sentiment-neutral {
      background: #fef3c7;
      color: #92400e;
    }
    
    /* Data table in analytics */
    .analytics-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    .analytics-table th {
      text-align: left;
      padding: 10px;
      background: #f8fafc;
      border-bottom: 2px solid #e2e8f0;
      font-weight: 600;
    }
    
    .analytics-table td {
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .analytics-table tr:hover {
      background: #f0f9ff;
    }
    
    /* Top reviews */
    .review-card {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .review-score {
      font-weight: 600;
      font-size: 16px;
    }
    
    .review-text {
      color: #4b5563;
      line-height: 1.5;
      max-height: 100px;
      overflow: hidden;
      position: relative;
    }
    
    .review-text.expanded {
      max-height: none;
    }
    
    .read-more {
      color: var(--primary-color);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    /* Column selector for analytics */
    .column-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .column-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .column-checkbox input {
      margin: 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
      .analytics-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }
      
      .table-toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .tab-nav {
        flex-wrap: wrap;
      }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>CSV Analytics Dashboard for Genesys Cloud</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with Genesys Cloud...</div>
    <div id="auth-progress" style="margin-top: 12px; text-align: center;">
      <div class="loading">
        <span class="spinner"></span>
        <span>Processing authentication...</span>
      </div>
    </div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Upload CSV File</h2>
      <div class="date-format-info">
        <strong><i class="bi bi-file-earmark-spreadsheet"></i> Advanced CSV Analytics Dashboard</strong>
        <p style="margin-top: 8px;">Upload CSV files for detailed analytics including sentiment analysis, word clouds, score trends, and more.</p>
      </div>
      <div class="help-text">
        <strong>Key Features:</strong>
        <ul>
          <li><strong>No-wrap table display</strong> with hover expansion</li>
          <li><strong>Advanced Analytics Tab</strong> with comprehensive metrics</li>
          <li><strong>Word Cloud generation</strong> from text/review fields</li>
          <li><strong>Score analysis</strong> with averages, distributions, and trends</li>
          <li><strong>Date range filtering</strong> for time-based analysis</li>
          <li><strong>Sentiment analysis</strong> of text content</li>
          <li><strong>Top reviews display</strong> with expandable text</li>
        </ul>
      </div>
      <div id="fileUploadArea" class="fileUploadArea">
        <div class="upload-icon"><i class="bi bi-cloud-arrow-up-fill"></i></div>
        <div><strong>Click to upload CSV file</strong></div>
        <div class="muted" style="margin-top: 8px;">or drag and drop your file here</div>
        <div class="muted">Supports: CSV, TSV, and other delimited files</div>
      </div>
      <input type="file" id="fileInput" accept=".csv,.txt,.tsv" style="display:none" />
      <div id="fileName" class="file-name"></div>
      
      <div style="margin-top: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <div class="delimiter-control" id="delimiterControl" style="display: none;">
          <label for="delimiterSelect"><i class="bi bi-textarea-t"></i> Delimiter:</label>
          <select id="delimiterSelect">
            <option value="auto">Auto-detect</option>
            <option value=",">Comma (,)</option>
            <option value=";" selected>Semicolon (;)</option>
            <option value="\t">Tab</option>
            <option value="|">Pipe (|)</option>
            <option value="custom">Custom...</option>
          </select>
          <input type="text" id="customDelimiter" style="display: none; width: 60px; padding: 4px;" placeholder="e.g., :" maxlength="1" />
        </div>
        <button id="reparseBtn" style="display:none;"><i class="bi bi-arrow-clockwise"></i> Reparse</button>
      </div>
      
      <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
        <button id="exportCsvBtn" style="display:none;"><i class="bi bi-download"></i> Export CSV</button>
        <button id="clearDataBtn" style="background: #dc3545; display:none;"><i class="bi bi-trash"></i> Clear All</button>
      </div>
    </div>

    <div class="tab-container">
      <div class="tab-nav">
        <button class="tab-button active" data-tab="dataTab"><i class="bi bi-table"></i> Data Table</button>
        <button class="tab-button" data-tab="analyticsTab" id="analyticsTabBtn" style="display:none;"><i class="bi bi-bar-chart-fill"></i> Analytics Dashboard</button>
      </div>
      
      <!-- Data Table Tab -->
      <div id="dataTab" class="tab-content active">
        <div class="card">
          <h2 class="section-title">CSV Data Table</h2>
          <div class="table-toolbar" id="tableToolbar" style="display: none;">
            <div class="search-box">
              <i class="bi bi-search"></i>
              <input type="text" id="tableSearch" placeholder="Search in table..." />
            </div>
            <div class="stat-item">
              <span>Selected:</span>
              <span id="selectedCount" class="stat-badge">0 cells</span>
            </div>
          </div>
          <div class="table-stats" id="tableStats">
            <!-- Table stats will be displayed here -->
          </div>
          <div class="table-container" id="tableContainer">
            <!-- Table will be rendered here -->
          </div>
        </div>
      </div>
      
      <!-- Analytics Tab -->
      <div id="analyticsTab" class="tab-content">
        <div class="card">
          <h2 class="section-title"><i class="bi bi-graph-up"></i> Analytics Dashboard</h2>
          
          <!-- Date Range Selector -->
          <div class="table-toolbar" id="analyticsToolbar" style="display: none;">
            <div class="date-range-selector">
              <label for="startDate"><i class="bi bi-calendar"></i> From:</label>
              <input type="date" id="startDate" />
              <label for="endDate">To:</label>
              <input type="date" id="endDate" />
              <button id="applyDateFilter"><i class="bi bi-funnel"></i> Apply Filter</button>
              <button id="clearDateFilter" style="background: #94a3b8;"><i class="bi bi-x-circle"></i> Clear</button>
            </div>
            <div class="stat-item">
              <span>Analyzing:</span>
              <span id="analyticsRowCount" class="stat-badge">0 rows</span>
            </div>
          </div>
          
          <!-- Column Selector for Analytics -->
          <div id="columnSelectorContainer" style="display: none; margin-top: 20px;">
            <h3 style="margin-bottom: 10px; font-size: 16px;"><i class="bi bi-columns"></i> Select Columns for Analysis</h3>
            <div class="column-selector" id="columnSelector">
              <!-- Column checkboxes will be inserted here -->
            </div>
          </div>
          
          <!-- Key Metrics -->
          <div class="analytics-section">
            <h3 class="analytics-section-title"><i class="bi bi-speedometer2"></i> Key Metrics</h3>
            <div class="analytics-grid" id="keyMetrics">
              <!-- Metrics will be populated here -->
            </div>
          </div>
          
          <!-- Word Cloud and Score Analysis -->
          <div class="analytics-section">
            <h3 class="analytics-section-title"><i class="bi bi-cloud-fill"></i> Text Analysis</h3>
            <div class="analytics-grid">
              <div class="metric-card">
                <div class="metric-title"><i class="bi bi-cloud-fill"></i> Word Cloud</div>
                <div class="word-cloud-container" id="wordCloud">
                  <!-- Word cloud will be generated here -->
                  <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
                    Select a text column to generate word cloud
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                  <select id="wordCloudColumn" style="width: 100%; padding: 8px;">
                    <option value="">Select text column for word cloud...</option>
                  </select>
                </div>
              </div>
              
              <div class="metric-card">
                <div class="metric-title"><i class="bi bi-percent"></i> Score Distribution</div>
                <div id="scoreDistribution">
                  <!-- Score distribution will be generated here -->
                  <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
                    Select a score column to see distribution
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                  <select id="scoreColumn" style="width: 100%; padding: 8px;">
                    <option value="">Select score column for analysis...</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sentiment Analysis and Top Reviews -->
          <div class="analytics-section">
            <h3 class="analytics-section-title"><i class="bi bi-chat-left-text"></i> Review Analysis</h3>
            <div class="analytics-grid">
              <div class="metric-card">
                <div class="metric-title"><i class="bi bi-emoji-smile"></i> Sentiment Analysis</div>
                <div id="sentimentAnalysis" style="padding: 20px 0;">
                  <!-- Sentiment analysis will be generated here -->
                  <div style="text-align: center; padding: 30px 20px; color: #94a3b8;">
                    Select a text column for sentiment analysis
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                  <select id="sentimentColumn" style="width: 100%; padding: 8px;">
                    <option value="">Select text column for sentiment...</option>
                  </select>
                </div>
              </div>
              
              <div class="metric-card">
                <div class="metric-title"><i class="bi bi-star-fill"></i> Top Reviews</div>
                <div id="topReviews" style="max-height: 300px; overflow-y: auto;">
                  <!-- Top reviews will be generated here -->
                  <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
                    Select text and score columns to see top reviews
                  </div>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #64748b; display: flex; gap: 10px;">
                  <select id="reviewTextColumn" style="flex: 1; padding: 8px;">
                    <option value="">Review text column...</option>
                  </select>
                  <select id="reviewScoreColumn" style="flex: 1; padding: 8px;">
                    <option value="">Score column...</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Data Quality and Column Analysis -->
          <div class="analytics-section">
            <h3 class="analytics-section-title"><i class="bi bi-clipboard-data"></i> Data Quality</h3>
            <div class="table-container">
              <table class="analytics-table" id="dataQualityTable">
                <thead>
                  <tr>
                    <th>Column Name</th>
                    <th>Data Type</th>
                    <th>Non-Empty Values</th>
                    <th>Empty Values</th>
                    <th>Completeness</th>
                    <th>Unique Values</th>
                  </tr>
                </thead>
                <tbody id="dataQualityBody">
                  <!-- Data quality rows will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Time Trends (if date column exists) -->
          <div class="analytics-section" id="timeTrendsSection" style="display: none;">
            <h3 class="analytics-section-title"><i class="bi bi-calendar-heart"></i> Time Trends</h3>
            <div class="analytics-grid">
              <div class="metric-card">
                <div class="metric-title"><i class="bi bi-graph-up-arrow"></i> Daily Volume</div>
                <div class="chart-container" id="dailyVolumeChart">
                  <!-- Daily volume chart will be generated here -->
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-title"><i class="bi bi-arrow-up-right"></i> Score Trend</div>
                <div class="chart-container" id="scoreTrendChart">
                  <!-- Score trend chart will be generated here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/CSAT-Uploader/';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    console.log('OAuth Configuration:');
    console.log('- Client ID:', clientId);
    console.log('- Redirect URI:', redirectUri);
    console.log('- Full OAuth URL:', oauthUrl);

    let accessToken = null;
    let csvData = [];
    let filteredData = [];
    let currentHeaders = [];
    let currentDelimiter = ';'; // Default to semicolon as requested
    let originalCsvText = '';
    let selectedCells = new Set();
    let sortColumn = null;
    let sortDirection = 'asc';
    let dateRangeFilter = null;

    // ===== Improved OAuth Handling =====
    document.addEventListener('DOMContentLoaded', () => {
      // Check if we're coming back from OAuth with an error or token
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      
      // Also check query parameters (some OAuth flows use these)
      const searchParams = new URLSearchParams(window.location.search);
      
      // Combine both hash and query params
      const allParams = new URLSearchParams(hash + '&' + searchParams.toString());
      
      const oauthError = allParams.get('error') || params.get('error') || searchParams.get('error');
      const oauthErrorDesc = allParams.get('error_description') || params.get('error_description') || searchParams.get('error_description');

      if (oauthError) {
        document.getElementById('auth-message').textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        document.getElementById('auth-message').className = 'error-message';
        document.getElementById('auth-progress').innerHTML = '';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });
        
        // Add retry button
        const retryBtn = document.createElement('button');
        retryBtn.textContent = 'Retry Authentication';
        retryBtn.style.marginTop = '12px';
        retryBtn.onclick = () => window.location.href = oauthUrl;
        document.getElementById('auth-progress').appendChild(retryBtn);
        return;
      }
      
      // Try to get token from hash first, then from query params
      accessToken = params.get('access_token') || searchParams.get('access_token');
      
      if (accessToken) {
        // Store token and clean URL
        sessionStorage.setItem('purecloud_token', accessToken);
        
        // Clean the URL - remove OAuth parameters
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        
        console.log('Authentication successful, token received');
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        // Use stored token
        accessToken = sessionStorage.getItem('purecloud_token');
        console.log('Using stored token');
        initializeApplication();
      } else {
        // No token found, start OAuth flow
        console.log('No authentication token found, initiating OAuth flow...');
        console.log('Redirecting to:', oauthUrl);
        
        // Small delay to show loading message
        setTimeout(() => {
          window.location.href = oauthUrl;
        }, 1000);
      }
    });
    
    function showMessage(msg, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display='none', 5000);
    }
    
    function initializeApplication() {
      console.log('Initializing application...');
      
      // Hide auth progress spinner
      document.getElementById('auth-progress').innerHTML = '';
      
      document.getElementById('auth-message').textContent = 'Authenticated with Genesys Cloud successfully!';
      document.getElementById('auth-message').className = 'success-message';
      
      // Small delay before showing app content for smoother transition
      setTimeout(() => {
        document.getElementById('authCard').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        
        // Setup event listeners
        setupEventListeners();
        
        // Display welcome message
        showMessage('Welcome! You are authenticated with Genesys Cloud. Upload a CSV file to begin.', 'success');
      }, 500);
    }
    
    function setupEventListeners() {
      // File upload area click
      document.getElementById('fileUploadArea').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });
      
      // File input change
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      
      // Delimiter select change
      document.getElementById('delimiterSelect').addEventListener('change', function() {
        const customDelimiterInput = document.getElementById('customDelimiter');
        if (this.value === 'custom') {
          customDelimiterInput.style.display = 'inline-block';
          customDelimiterInput.focus();
        } else {
          customDelimiterInput.style.display = 'none';
        }
      });
      
      // Custom delimiter input
      document.getElementById('customDelimiter').addEventListener('input', function(e) {
        if (this.value.length > 0) {
          currentDelimiter = this.value;
        }
      });
      
      // Reparse button
      document.getElementById('reparseBtn').addEventListener('click', () => {
        if (originalCsvText) {
          parseCSV(originalCsvText);
        }
      });
      
      // Tab switching
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          const tabId = button.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
      
      // Date filter
      document.getElementById('applyDateFilter')?.addEventListener('click', applyDateFilter);
      document.getElementById('clearDateFilter')?.addEventListener('click', clearDateFilter);
      
      // Analytics column selectors
      document.getElementById('wordCloudColumn')?.addEventListener('change', generateWordCloud);
      document.getElementById('scoreColumn')?.addEventListener('change', generateScoreDistribution);
      document.getElementById('sentimentColumn')?.addEventListener('change', generateSentimentAnalysis);
      document.getElementById('reviewTextColumn')?.addEventListener('change', updateTopReviews);
      document.getElementById('reviewScoreColumn')?.addEventListener('change', updateTopReviews);
      
      // Drag and drop
      const uploadArea = document.getElementById('fileUploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-color)';
        uploadArea.style.background = '#f0f7f4';
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.background = 'var(--light-bg)';
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
        uploadArea.style.borderColor = 'var(--border-color)';
        uploadArea.style.background = 'var(--light-bg)';
      });
      
      // Export button
      document.getElementById('exportCsvBtn').addEventListener('click', exportAsCsv);
      
      // Clear button
      document.getElementById('clearDataBtn').addEventListener('click', clearData);
      
      // Table search
      document.getElementById('tableSearch')?.addEventListener('input', function(e) {
        searchTable(e.target.value);
      });
    }
    
    // Tab switching function
    function switchTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.toggle('active', button.getAttribute('data-tab') === tabId);
      });
      
      // Update tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === tabId);
      });
      
      // If switching to analytics tab, update analytics
      if (tabId === 'analyticsTab' && csvData.length > 0) {
        updateAnalytics();
      }
    }
    
    // Handle file selection
    function handleFileSelect(e) {
      const file = e.target.files[0];
      handleFile(file);
    }
    
    function handleFile(file) {
      if (!file) return;
      
      // Check file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showMessage('File size exceeds 10MB limit', 'error');
        return;
      }
      
      // Update UI
      document.getElementById('fileName').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      document.getElementById('fileUploadArea').classList.add('has-file');
      
      // Show delimiter controls and buttons
      document.getElementById('delimiterControl').style.display = 'flex';
      document.getElementById('reparseBtn').style.display = 'inline-block';
      document.getElementById('exportCsvBtn').style.display = 'inline-block';
      document.getElementById('clearDataBtn').style.display = 'inline-block';
      
      // Show analytics tab button
      document.getElementById('analyticsTabBtn').style.display = 'inline-block';
      
      // Read and process CSV
      readCSVFile(file);
    }
    
    // Read CSV file
    function readCSVFile(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        originalCsvText = e.target.result;
        parseCSV(originalCsvText);
      };
      
      reader.onerror = function() {
        showMessage('Error reading file', 'error');
      };
      
      reader.readAsText(file, 'UTF-8');
    }
    
    // Detect delimiter from text
    function detectDelimiter(text) {
      const lines = text.split('\n').slice(0, 10);
      const delimiters = [',', ';', '\t', '|'];
      let bestDelimiter = ';'; // Default to semicolon
      let bestScore = 0;
      
      for (const delimiter of delimiters) {
        let score = 0;
        for (const line of lines) {
          if (line.trim()) {
            const parts = line.split(delimiter);
            if (parts.length > 1) {
              score += parts.length;
            }
          }
        }
        
        if (score > bestScore) {
          bestScore = score;
          bestDelimiter = delimiter;
        }
      }
      
      return bestDelimiter;
    }
    
    // Parse CSV data
    function parseCSV(csvText) {
      try {
        // Reset data
        csvData = [];
        filteredData = [];
        selectedCells.clear();
        
        // Get selected delimiter
        const delimiterSelect = document.getElementById('delimiterSelect');
        let delimiter = currentDelimiter;
        
        if (delimiterSelect.value === 'auto') {
          delimiter = detectDelimiter(csvText);
          showMessage(`Auto-detected delimiter: "${delimiter === '\t' ? 'Tab' : delimiter}"`, 'info');
        } else if (delimiterSelect.value === 'custom') {
          delimiter = document.getElementById('customDelimiter').value || ';';
        } else {
          delimiter = delimiterSelect.value;
        }
        
        currentDelimiter = delimiter;
        
        // Parse CSV using proper CSV parsing logic with detected delimiter
        const rows = parseCSVText(csvText, delimiter);
        
        if (rows.length === 0) {
          showMessage('CSV file is empty', 'error');
          return;
        }
        
        // Get headers from first row
        currentHeaders = rows[0].map(h => h.trim().replace(/^"|"$/g, ''));
        
        // Process data rows
        for (let i = 1; i < rows.length; i++) {
          const rowValues = rows[i];
          const row = {};
          
          // Map each header to its value
          currentHeaders.forEach((header, index) => {
            const value = (rowValues[index] || '').trim().replace(/^"|"$/g, '');
            row[header] = value;
          });
          
          // Only add row if it has any data
          if (Object.values(row).some(val => val)) {
            csvData.push(row);
          }
        }
        
        if (csvData.length === 0) {
          showMessage('No valid data found in CSV file', 'error');
          return;
        }
        
        console.log(`Parsed ${csvData.length} rows from CSV with ${currentHeaders.length} columns using delimiter: "${delimiter}"`);
        
        // Set filtered data to all data initially
        filteredData = [...csvData];
        
        // Show data
        renderTable();
        
        // Show data section and toolbar
        document.getElementById('dataTableCard').style.display = 'block';
        document.getElementById('tableToolbar').style.display = 'flex';
        
        // Setup analytics
        setupAnalytics();
        
        showMessage(`Successfully loaded ${csvData.length} rows from CSV (using "${delimiter === '\t' ? 'Tab' : delimiter}" delimiter)`, 'success');
        
      } catch (error) {
        console.error('Error parsing CSV:', error);
        showMessage(`Error parsing CSV: ${error.message}. Try selecting a different delimiter.`, 'error');
      }
    }
    
    // Proper CSV parser that handles quoted values with custom delimiters
    function parseCSVText(text, delimiter = ';') {
      const rows = [];
      let currentRow = [];
      let currentField = '';
      let insideQuotes = false;
      
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];
        
        if (char === '"') {
          if (insideQuotes && nextChar === '"') {
            // Escaped quote
            currentField += '"';
            i++; // Skip next quote
          } else {
            // Start or end quotes
            insideQuotes = !insideQuotes;
          }
        } else if (char === delimiter && !insideQuotes) {
          // End of field
          currentRow.push(currentField);
          currentField = '';
        } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !insideQuotes) {
          // End of row (handle both \n and \r\n)
          if (char === '\r') i++; // Skip \n after \r
          currentRow.push(currentField);
          rows.push(currentRow);
          currentRow = [];
          currentField = '';
        } else {
          currentField += char;
        }
      }
      
      // Add the last field and row
      if (currentField !== '' || currentRow.length > 0) {
        currentRow.push(currentField);
        rows.push(currentRow);
      }
      
      // Remove any completely empty rows
      return rows.filter(row => row.some(field => field.trim() !== ''));
    }
    
    // Render Excel-like table with NO WRAP
    function renderTable() {
      const tableContainer = document.getElementById('tableContainer');
      const tableStats = document.getElementById('tableStats');
      
      // Clear container
      tableContainer.innerHTML = '';
      
      // Update table stats
      tableStats.innerHTML = `
        <div class="stat-item">
          <span>Rows:</span>
          <span class="stat-badge">${filteredData.length.toLocaleString()}</span>
        </div>
        <div class="stat-item">
          <span>Columns:</span>
          <span class="stat-badge">${currentHeaders.length}</span>
        </div>
        <div class="stat-item">
          <span>Delimiter:</span>
          <span class="stat-badge">${currentDelimiter === '\t' ? 'Tab' : currentDelimiter}</span>
        </div>
        <div class="stat-item">
          <span>File:</span>
          <span>${document.getElementById('fileName').textContent}</span>
        </div>
      `;
      
      if (filteredData.length === 0) {
        tableContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6c757d;">
            No data available. Upload a CSV file to see the table.
          </div>
        `;
        return;
      }
      
      // Create table
      const table = document.createElement('table');
      table.className = 'excel-table';
      table.id = 'dataTable';
      
      // Create header row
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      
      currentHeaders.forEach((header, colIndex) => {
        const th = document.createElement('th');
        th.textContent = header;
        th.dataset.column = header;
        
        // Add sort indicator if this column is sorted
        if (sortColumn === header) {
          th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
        
        // Add click handler for sorting
        th.addEventListener('click', () => {
          sortTable(header);
        });
        
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create table body
      const tbody = document.createElement('tbody');
      
      filteredData.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = rowIndex;
        
        currentHeaders.forEach((header, colIndex) => {
          const td = document.createElement('td');
          const cellValue = row[header] || '';
          td.textContent = cellValue;
          td.dataset.row = rowIndex;
          td.dataset.col = colIndex;
          td.dataset.header = header;
          
          // NO WRAP implementation
          td.style.whiteSpace = 'nowrap';
          td.style.overflow = 'hidden';
          td.style.textOverflow = 'ellipsis';
          td.style.maxWidth = '300px';
          
          // Add cell classes based on content
          if (!cellValue.trim()) {
            td.classList.add('empty-cell');
          }
          
          // Check if numeric
          if (!isNaN(cellValue) && cellValue.trim() !== '' && cellValue.trim().indexOf(' ') === -1) {
            td.classList.add('cell-numeric');
          }
          
          // Check if date (simple detection)
          if (cellValue.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/) || 
              cellValue.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/)) {
            td.classList.add('cell-date');
          }
          
          // Add title for hover (shows full content on hover)
          td.title = cellValue;
          
          // Add hover effect to show full content
          td.addEventListener('mouseenter', function() {
            this.style.overflow = 'visible';
            this.style.whiteSpace = 'normal';
            this.style.position = 'relative';
            this.style.zIndex = '100';
            this.style.backgroundColor = '#f0f9ff';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,.1)';
            this.style.maxWidth = 'none';
          });
          
          td.addEventListener('mouseleave', function() {
            this.style.overflow = 'hidden';
            this.style.whiteSpace = 'nowrap';
            this.style.position = '';
            this.style.zIndex = '';
            this.style.backgroundColor = '';
            this.style.boxShadow = '';
            this.style.maxWidth = '300px';
          });
          
          // Add click handler for selection
          td.addEventListener('click', (e) => {
            if (e.shiftKey) {
              // Multi-select with shift
              td.classList.toggle('cell-selected');
              const cellId = `${rowIndex}-${colIndex}`;
              if (selectedCells.has(cellId)) {
                selectedCells.delete(cellId);
              } else {
                selectedCells.add(cellId);
              }
            } else {
              // Single select
              document.querySelectorAll('.cell-selected').forEach(cell => {
                cell.classList.remove('cell-selected');
              });
              td.classList.add('cell-selected');
              selectedCells.clear();
              selectedCells.add(`${rowIndex}-${colIndex}`);
            }
            updateSelectedCount();
          });
          
          tr.appendChild(td);
        });
        
        tbody.appendChild(tr);
      });
      
      table.appendChild(tbody);
      tableContainer.appendChild(table);
      
      // Initialize selected count
      updateSelectedCount();
    }
    
    // Sort table by column
    function sortTable(column) {
      if (sortColumn === column) {
        // Toggle direction if same column
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      filteredData.sort((a, b) => {
        const valA = a[column] || '';
        const valB = b[column] || '';
        
        // Try numeric comparison first
        const numA = parseFloat(valA);
        const numB = parseFloat(valB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
          return sortDirection === 'asc' ? numA - numB : numB - numA;
        }
        
        // String comparison
        const strA = String(valA).toLowerCase();
        const strB = String(valB).toLowerCase();
        
        if (sortDirection === 'asc') {
          return strA.localeCompare(strB);
        } else {
          return strB.localeCompare(strA);
        }
      });
      
      renderTable();
    }
    
    // Search within table
    function searchTable(searchTerm) {
      if (!searchTerm) {
        // Clear all highlights
        document.querySelectorAll('.cell-highlight').forEach(cell => {
          cell.classList.remove('cell-highlight');
        });
        return;
      }
      
      const searchLower = searchTerm.toLowerCase();
      const table = document.getElementById('dataTable');
      
      if (!table) return;
      
      // Clear previous highlights
      document.querySelectorAll('.cell-highlight').forEach(cell => {
        cell.classList.remove('cell-highlight');
      });
      
      // Search in all cells
      const cells = table.querySelectorAll('td');
      let matchCount = 0;
      
      cells.forEach(cell => {
        if (cell.textContent.toLowerCase().includes(searchLower)) {
          cell.classList.add('cell-highlight');
          matchCount++;
        }
      });
      
      // Update search stats
      const searchBox = document.querySelector('.search-box');
      if (searchBox) {
        let statsSpan = searchBox.querySelector('.search-stats');
        if (!statsSpan) {
          statsSpan = document.createElement('span');
          statsSpan.className = 'search-stats';
          statsSpan.style.fontSize = '11px';
          statsSpan.style.marginLeft = '8px';
          searchBox.appendChild(statsSpan);
        }
        statsSpan.textContent = matchCount > 0 ? `${matchCount} matches` : 'No matches';
      }
    }
    
    // Setup analytics after data is loaded
    function setupAnalytics() {
      // Show analytics toolbar
      document.getElementById('analyticsToolbar').style.display = 'flex';
      
      // Update analytics row count
      document.getElementById('analyticsRowCount').textContent = `${filteredData.length} rows`;
      
      // Populate column selectors
      populateColumnSelectors();
      
      // Setup date range defaults
      setupDateRange();
      
      // Generate initial analytics
      updateAnalytics();
    }
    
    // Populate column selectors for analytics
    function populateColumnSelectors() {
      const wordCloudSelect = document.getElementById('wordCloudColumn');
      const scoreSelect = document.getElementById('scoreColumn');
      const sentimentSelect = document.getElementById('sentimentColumn');
      const reviewTextSelect = document.getElementById('reviewTextColumn');
      const reviewScoreSelect = document.getElementById('reviewScoreColumn');
      
      // Clear existing options except first
      [wordCloudSelect, scoreSelect, sentimentSelect, reviewTextSelect, reviewScoreSelect].forEach(select => {
        while (select.options.length > 1) {
          select.remove(1);
        }
      });
      
      // Add columns to selectors
      currentHeaders.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        
        wordCloudSelect.appendChild(option.cloneNode(true));
        sentimentSelect.appendChild(option.cloneNode(true));
        reviewTextSelect.appendChild(option.cloneNode(true));
        
        // For score columns, try to identify numeric columns
        if (isColumnNumeric(header)) {
          scoreSelect.appendChild(option.cloneNode(true));
          reviewScoreSelect.appendChild(option.cloneNode(true));
        }
      });
      
      // Auto-select likely columns based on common names
      autoSelectCommonColumns();
    }
    
    // Check if column is numeric
    function isColumnNumeric(columnName) {
      const sampleValues = filteredData.slice(0, 10).map(row => row[columnName]);
      let numericCount = 0;
      
      sampleValues.forEach(value => {
        if (value && !isNaN(value) && value.trim() !== '') {
          numericCount++;
        }
      });
      
      return numericCount > 5; // If more than 5 of first 10 are numeric
    }
    
    // Auto-select common column names
    function autoSelectCommonColumns() {
      const commonScoreNames = ['score', 'rating', 'percent', 'percentage', 'csat', 'nps', 'satisfaction'];
      const commonTextNames = ['review', 'comment', 'feedback', 'text', 'response', 'note'];
      const commonDateNames = ['date', 'time', 'timestamp', 'created', 'submitted'];
      
      currentHeaders.forEach(header => {
        const lowerHeader = header.toLowerCase();
        
        // Auto-select score column
        if (commonScoreNames.some(name => lowerHeader.includes(name))) {
          document.getElementById('scoreColumn').value = header;
          document.getElementById('reviewScoreColumn').value = header;
        }
        
        // Auto-select text column
        if (commonTextNames.some(name => lowerHeader.includes(name))) {
          document.getElementById('wordCloudColumn').value = header;
          document.getElementById('sentimentColumn').value = header;
          document.getElementById('reviewTextColumn').value = header;
        }
      });
    }
    
    // Setup date range picker
    function setupDateRange() {
      // Find date columns
      const dateColumns = currentHeaders.filter(header => {
        const sampleValues = filteredData.slice(0, 5).map(row => row[header]);
        return sampleValues.some(value => 
          value && (value.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/) || 
                   value.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/))
        );
      });
      
      if (dateColumns.length > 0) {
        // Show time trends section
        document.getElementById('timeTrendsSection').style.display = 'block';
        
        // Set default date range to last 30 days if possible
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        
        document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
        document.getElementById('endDate').valueAsDate = today;
      }
    }
    
    // Apply date filter
    function applyDateFilter() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        showMessage('Please select both start and end dates', 'error');
        return;
      }
      
      const start = new Date(startDate);
      const end = new Date(endDate);
      
      if (start > end) {
        showMessage('Start date must be before end date', 'error');
        return;
      }
      
      // Find date column
      const dateColumn = findDateColumn();
      if (!dateColumn) {
        showMessage('No date column found in the data', 'error');
        return;
      }
      
      // Filter data
      filteredData = csvData.filter(row => {
        const dateStr = row[dateColumn];
        if (!dateStr) return false;
        
        const date = parseDate(dateStr);
        if (!date) return false;
        
        return date >= start && date <= end;
      });
      
      dateRangeFilter = { start, end, column: dateColumn };
      
      // Update UI
      document.getElementById('analyticsRowCount').textContent = `${filteredData.length} rows (filtered)`;
      
      // Update table and analytics
      renderTable();
      updateAnalytics();
      
      showMessage(`Filtered to ${filteredData.length} rows from ${startDate} to ${endDate}`, 'success');
    }
    
    // Clear date filter
    function clearDateFilter() {
      filteredData = [...csvData];
      dateRangeFilter = null;
      
      // Update UI
      document.getElementById('analyticsRowCount').textContent = `${filteredData.length} rows`;
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      
      // Update table and analytics
      renderTable();
      updateAnalytics();
      
      showMessage('Date filter cleared', 'success');
    }
    
    // Find date column in data
    function findDateColumn() {
      // First check for common date column names
      const commonDateNames = ['date', 'time', 'timestamp', 'created', 'submitted', 'datetime'];
      
      for (const header of currentHeaders) {
        const lowerHeader = header.toLowerCase();
        if (commonDateNames.some(name => lowerHeader.includes(name))) {
          return header;
        }
      }
      
      // If no common names, check column content
      for (const header of currentHeaders) {
        const sampleValues = filteredData.slice(0, 10).map(row => row[header]);
        const dateCount = sampleValues.filter(value => 
          value && (value.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/) || 
                   value.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/))
        ).length;
        
        if (dateCount > 5) { // If more than 5 of first 10 look like dates
          return header;
        }
      }
      
      return null;
    }
    
    // Parse date from string
    function parseDate(dateStr) {
      if (!dateStr) return null;
      
      // Try different date formats
      const formats = [
        /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/, // DD/MM/YYYY or DD-MM-YYYY
        /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/, // YYYY-MM-DD
        /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/, // DD/MM/YY or DD-MM-YY
      ];
      
      for (const format of formats) {
        const match = dateStr.match(format);
        if (match) {
          if (format.toString().includes('^\\d{4}')) {
            // YYYY-MM-DD
            return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
          } else {
            // DD/MM/YYYY or DD/MM/YY
            const year = match[3].length === 4 ? parseInt(match[3]) : 
                        parseInt(match[3]) < 50 ? 2000 + parseInt(match[3]) : 1900 + parseInt(match[3]);
            return new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));
          }
        }
      }
      
      // Try Date.parse as last resort
      const parsed = Date.parse(dateStr);
      if (!isNaN(parsed)) {
        return new Date(parsed);
      }
      
      return null;
    }
    
    // Update all analytics
    function updateAnalytics() {
      updateKeyMetrics();
      generateWordCloud();
      generateScoreDistribution();
      generateSentimentAnalysis();
      updateTopReviews();
      updateDataQuality();
      updateTimeTrends();
    }
    
    // Update key metrics
    function updateKeyMetrics() {
      const keyMetrics = document.getElementById('keyMetrics');
      
      // Calculate basic metrics
      const totalRows = filteredData.length;
      const totalColumns = currentHeaders.length;
      
      // Find score column and calculate average
      const scoreColumn = document.getElementById('scoreColumn').value;
      let avgScore = 'N/A';
      let scoreCount = 0;
      
      if (scoreColumn) {
        const scores = filteredData
          .map(row => parseFloat(row[scoreColumn]))
          .filter(score => !isNaN(score));
        
        if (scores.length > 0) {
          const sum = scores.reduce((a, b) => a + b, 0);
          avgScore = (sum / scores.length).toFixed(1);
          scoreCount = scores.length;
        }
      }
      
      // Calculate completeness
      const totalCells = totalRows * totalColumns;
      let nonEmptyCells = 0;
      
      filteredData.forEach(row => {
        currentHeaders.forEach(header => {
          if (row[header] && row[header].trim() !== '') {
            nonEmptyCells++;
          }
        });
      });
      
      const completeness = totalCells > 0 ? Math.round((nonEmptyCells / totalCells) * 100) : 0;
      
      // Create metrics HTML
      keyMetrics.innerHTML = `
        <div class="metric-card">
          <div class="metric-title"><i class="bi bi-table"></i> Data Volume</div>
          <div class="metric-value">${totalRows.toLocaleString()}</div>
          <div class="metric-change">Total rows in dataset</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-title"><i class="bi bi-percent"></i> Average Score</div>
          <div class="metric-value">${avgScore}</div>
          <div class="metric-change">${scoreCount > 0 ? `Based on ${scoreCount} scores` : 'No score column selected'}</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-title"><i class="bi bi-check-circle"></i> Data Completeness</div>
          <div class="metric-value">${completeness}%</div>
          <div class="metric-change">${nonEmptyCells.toLocaleString()} of ${totalCells.toLocaleString()} cells filled</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-title"><i class="bi bi-calendar"></i> Date Range</div>
          <div class="metric-value">${dateRangeFilter ? 'Filtered' : 'All Data'}</div>
          <div class="metric-change">${dateRangeFilter ? 
            `${dateRangeFilter.start.toLocaleDateString()} - ${dateRangeFilter.end.toLocaleDateString()}` : 
            'No date filter applied'}</div>
        </div>
      `;
    }
    
    // Generate word cloud
    function generateWordCloud() {
      const wordCloudContainer = document.getElementById('wordCloud');
      const column = document.getElementById('wordCloudColumn').value;
      
      if (!column) {
        wordCloudContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            Select a text column to generate word cloud
          </div>
        `;
        return;
      }
      
      // Extract text from selected column
      const textData = filteredData
        .map(row => row[column] || '')
        .filter(text => text.trim() !== '')
        .join(' ')
        .toLowerCase();
      
      if (!textData.trim()) {
        wordCloudContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            No text data in selected column
          </div>
        `;
        return;
      }
      
      // Process text: remove common words, count frequencies
      const stopWords = new Set([
        'the', 'and', 'a', 'an', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by',
        'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had',
        'do', 'does', 'did', 'will', 'would', 'should', 'could', 'can', 'may',
        'might', 'must', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'this',
        'that', 'these', 'those', 'am', 'my', 'your', 'his', 'her', 'its', 'our',
        'their', 'as', 'from', 'or', 'but', 'not', 'so', 'then', 'than', 'too',
        'very', 'just', 'also', 'about', 'like', 'what', 'which', 'who', 'whom',
        'how', 'when', 'where', 'why', 'all', 'any', 'both', 'each', 'few', 'more',
        'most', 'other', 'some', 'such', 'no', 'nor', 'only', 'own', 'same',
        'here', 'there', 'up', 'down', 'out', 'off', 'over', 'under', 'again',
        'further', 'once', 'while', 'because', 'since', 'until', 'though',
        'although', 'whether', 'while', 'before', 'after', 'above', 'below',
        'through', 'during', 'between', 'into', 'within', 'without'
      ]);
      
      // Tokenize and count words
      const words = textData.match(/\b[a-z]{3,}\b/g) || [];
      const wordCounts = {};
      
      words.forEach(word => {
        if (!stopWords.has(word) && word.length > 2) {
          wordCounts[word] = (wordCounts[word] || 0) + 1;
        }
      });
      
      // Get top 50 words
      const topWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 50);
      
      if (topWords.length === 0) {
        wordCloudContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            No significant words found after filtering common words
          </div>
        `;
        return;
      }
      
      // Find max and min frequencies for scaling
      const maxFreq = Math.max(...topWords.map(w => w[1]));
      const minFreq = Math.min(...topWords.map(w => w[1]));
      const range = maxFreq - minFreq;
      
      // Generate word cloud HTML
      wordCloudContainer.innerHTML = '';
      
      topWords.forEach(([word, count]) => {
        // Calculate font size based on frequency (12px to 36px)
        const fontSize = 12 + (count - minFreq) / range * 24;
        
        // Calculate color intensity
        const intensity = 0.3 + (count - minFreq) / range * 0.7;
        const r = Math.floor(99 * intensity);
        const g = Math.floor(171 * intensity);
        const b = Math.floor(143 * intensity);
        const color = `rgb(${r}, ${g}, ${b})`;
        
        const wordElement = document.createElement('span');
        wordElement.className = 'word-cloud-word';
        wordElement.textContent = word;
        wordElement.title = `Frequency: ${count}`;
        wordElement.style.fontSize = `${fontSize}px`;
        wordElement.style.color = color;
        wordElement.style.opacity = 0.7 + intensity * 0.3;
        
        wordElement.addEventListener('click', () => {
          // Filter table to show rows containing this word
          searchTable(word);
          switchTab('dataTab');
        });
        
        wordCloudContainer.appendChild(wordElement);
      });
    }
    
    // Generate score distribution
    function generateScoreDistribution() {
      const scoreContainer = document.getElementById('scoreDistribution');
      const column = document.getElementById('scoreColumn').value;
      
      if (!column) {
        scoreContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            Select a score column to see distribution
          </div>
        `;
        return;
      }
      
      // Extract scores
      const scores = filteredData
        .map(row => parseFloat(row[column]))
        .filter(score => !isNaN(score));
      
      if (scores.length === 0) {
        scoreContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            No numeric scores found in selected column
          </div>
        `;
        return;
      }
      
      // Calculate statistics
      const sum = scores.reduce((a, b) => a + b, 0);
      const average = sum / scores.length;
      const min = Math.min(...scores);
      const max = Math.max(...scores);
      
      // Create score ranges (0-10, 11-20, etc. for percentage scores)
      const ranges = [];
      for (let i = 0; i <= 100; i += 10) {
        ranges.push({ min: i, max: i + 9, count: 0 });
      }
      
      // Count scores in each range
      scores.forEach(score => {
        const rangeIndex = Math.floor(score / 10);
        if (rangeIndex >= 0 && rangeIndex < ranges.length) {
          ranges[rangeIndex].count++;
        }
      });
      
      // Find max count for scaling
      const maxCount = Math.max(...ranges.map(r => r.count));
      
      // Generate distribution HTML
      let html = `
        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div>
              <strong>Average:</strong> ${average.toFixed(1)}%
            </div>
            <div>
              <strong>Range:</strong> ${min.toFixed(0)}% - ${max.toFixed(0)}%
            </div>
            <div>
              <strong>Count:</strong> ${scores.length}
            </div>
          </div>
        </div>
      `;
      
      // Add score bars
      ranges.forEach(range => {
        if (range.max <= 100) { // Only show up to 100%
          const percentage = maxCount > 0 ? (range.count / maxCount) * 100 : 0;
          const rangeLabel = range.min === 0 ? '0-9' : 
                           range.max === 100 ? '90-100' : 
                           `${range.min}-${range.max}`;
          
          // Determine color based on score range
          let color;
          if (range.min >= 90) color = '#10b981'; // Green for high scores
          else if (range.min >= 70) color = '#f59e0b'; // Orange for medium scores
          else color = '#ef4444'; // Red for low scores
          
          html += `
            <div class="score-label">
              <span>${rangeLabel}%</span>
              <span>${range.count} (${((range.count / scores.length) * 100).toFixed(1)}%)</span>
            </div>
            <div class="score-bar">
              <div class="score-fill" style="width: ${percentage}%; background: ${color};"></div>
            </div>
          `;
        }
      });
      
      scoreContainer.innerHTML = html;
    }
    
    // Generate sentiment analysis
    function generateSentimentAnalysis() {
      const sentimentContainer = document.getElementById('sentimentAnalysis');
      const column = document.getElementById('sentimentColumn').value;
      
      if (!column) {
        sentimentContainer.innerHTML = `
          <div style="text-align: center; padding: 30px 20px; color: #94a3b8;">
            Select a text column for sentiment analysis
          </div>
        `;
        return;
      }
      
      // Extract text from selected column
      const texts = filteredData
        .map(row => row[column] || '')
        .filter(text => text.trim() !== '');
      
      if (texts.length === 0) {
        sentimentContainer.innerHTML = `
          <div style="text-align: center; padding: 30px 20px; color: #94a3b8;">
            No text data in selected column
          </div>
        `;
        return;
      }
      
      // Simple sentiment analysis based on keyword matching
      const positiveWords = [
        'good', 'great', 'excellent', 'amazing', 'awesome', 'perfect', 'love', 'liked',
        'happy', 'satisfied', 'pleased', 'wonderful', 'fantastic', 'best', 'helpful',
        'friendly', 'quick', 'fast', 'easy', 'smooth', 'perfect', 'outstanding'
      ];
      
      const negativeWords = [
        'bad', 'poor', 'terrible', 'awful', 'horrible', 'hate', 'dislike', 'angry',
        'unhappy', 'dissatisfied', 'disappointed', 'frustrated', 'slow', 'difficult',
        'hard', 'complicated', 'broken', 'failed', 'error', 'issue', 'problem', 'wrong'
      ];
      
      let positiveCount = 0;
      let negativeCount = 0;
      let neutralCount = 0;
      
      texts.forEach(text => {
        const lowerText = text.toLowerCase();
        let positiveMatches = 0;
        let negativeMatches = 0;
        
        positiveWords.forEach(word => {
          if (lowerText.includes(word)) positiveMatches++;
        });
        
        negativeWords.forEach(word => {
          if (lowerText.includes(word)) negativeMatches++;
        });
        
        if (positiveMatches > negativeMatches) {
          positiveCount++;
        } else if (negativeMatches > positiveMatches) {
          negativeCount++;
        } else {
          neutralCount++;
        }
      });
      
      const total = texts.length;
      
      // Generate sentiment analysis HTML
      sentimentContainer.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 14px; color: #64748b; margin-bottom: 10px;">
            Analyzed ${total} text entries
          </div>
          <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
            <div style="text-align: center;">
              <div class="sentiment-badge sentiment-positive">Positive</div>
              <div style="font-size: 24px; font-weight: bold; color: #10b981;">${((positiveCount / total) * 100).toFixed(1)}%</div>
              <div style="font-size: 12px; color: #64748b;">${positiveCount} entries</div>
            </div>
            <div style="text-align: center;">
              <div class="sentiment-badge sentiment-neutral">Neutral</div>
              <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${((neutralCount / total) * 100).toFixed(1)}%</div>
              <div style="font-size: 12px; color: #64748b;">${neutralCount} entries</div>
            </div>
            <div style="text-align: center;">
              <div class="sentiment-badge sentiment-negative">Negative</div>
              <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${((negativeCount / total) * 100).toFixed(1)}%</div>
              <div style="font-size: 12px; color: #64748b;">${negativeCount} entries</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <div style="font-size: 14px; color: #64748b; margin-bottom: 10px;">Sentiment Distribution</div>
          <div style="display: flex; height: 30px; border-radius: 4px; overflow: hidden;">
            <div style="flex: ${positiveCount}; background: #10b981;" title="Positive: ${positiveCount}"></div>
            <div style="flex: ${neutralCount}; background: #f59e0b;" title="Neutral: ${neutralCount}"></div>
            <div style="flex: ${negativeCount}; background: #ef4444;" title="Negative: ${negativeCount}"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 11px; color: #64748b; margin-top: 5px;">
            <div>${((positiveCount / total) * 100).toFixed(0)}% Positive</div>
            <div>${((neutralCount / total) * 100).toFixed(0)}% Neutral</div>
            <div>${((negativeCount / total) * 100).toFixed(0)}% Negative</div>
          </div>
        </div>
      `;
    }
    
    // Update top reviews
    function updateTopReviews() {
      const topReviewsContainer = document.getElementById('topReviews');
      const textColumn = document.getElementById('reviewTextColumn').value;
      const scoreColumn = document.getElementById('reviewScoreColumn').value;
      
      if (!textColumn || !scoreColumn) {
        topReviewsContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            Select text and score columns to see top reviews
          </div>
        `;
        return;
      }
      
      // Get reviews with scores
      const reviews = filteredData
        .map(row => ({
          text: row[textColumn] || '',
          score: parseFloat(row[scoreColumn]) || 0,
          id: Math.random().toString(36).substr(2, 9)
        }))
        .filter(review => review.text.trim() !== '' && !isNaN(review.score))
        .sort((a, b) => b.score - a.score)
        .slice(0, 10); // Top 10 reviews
      
      if (reviews.length === 0) {
        topReviewsContainer.innerHTML = `
          <div style="text-align: center; padding: 50px 20px; color: #94a3b8;">
            No reviews found with both text and score
          </div>
        `;
        return;
      }
      
      // Generate reviews HTML
      topReviewsContainer.innerHTML = '';
      
      reviews.forEach((review, index) => {
        const reviewCard = document.createElement('div');
        reviewCard.className = 'review-card';
        
        // Determine sentiment color based on score
        let scoreColor = '#ef4444'; // Red for low scores
        if (review.score >= 70) scoreColor = '#f59e0b'; // Orange for medium
        if (review.score >= 90) scoreColor = '#10b981'; // Green for high
        
        reviewCard.innerHTML = `
          <div class="review-header">
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="font-weight: 600; color: #64748b;">#${index + 1}</div>
              <div class="review-score" style="color: ${scoreColor};">${review.score.toFixed(1)}%</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8;">${review.text.length > 200 ? 'Long' : 'Short'} review</div>
          </div>
          <div class="review-text" id="review-text-${review.id}">
            ${review.text}
          </div>
          ${review.text.length > 200 ? `
            <div class="read-more" onclick="toggleReviewText('${review.id}')">
              Read more
            </div>
          ` : ''}
        `;
        
        topReviewsContainer.appendChild(reviewCard);
      });
    }
    
    // Toggle review text expansion
    window.toggleReviewText = function(reviewId) {
      const reviewText = document.getElementById(`review-text-${reviewId}`);
      const readMoreLink = reviewText.nextElementSibling;
      
      reviewText.classList.toggle('expanded');
      
      if (reviewText.classList.contains('expanded')) {
        readMoreLink.textContent = 'Read less';
      } else {
        readMoreLink.textContent = 'Read more';
      }
    };
    
    // Update data quality table
    function updateDataQuality() {
      const dataQualityBody = document.getElementById('dataQualityBody');
      
      let html = '';
      
      currentHeaders.forEach(header => {
        const values = filteredData.map(row => row[header] || '');
        const nonEmpty = values.filter(v => v.trim() !== '');
        const empty = values.length - nonEmpty.length;
        const completeness = values.length > 0 ? Math.round((nonEmpty.length / values.length) * 100) : 0;
        
        // Count unique values
        const uniqueValues = new Set(nonEmpty.map(v => v.toLowerCase().trim()));
        
        // Determine data type
        let dataType = 'Text';
        const sampleValues = nonEmpty.slice(0, 10);
        
        if (sampleValues.length > 0) {
          const numericCount = sampleValues.filter(v => !isNaN(v) && v.trim() !== '' && v.indexOf(' ') === -1).length;
          const dateCount = sampleValues.filter(v => 
            v && (v.match(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/) || 
                 v.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/))
          ).length;
          
          if (dateCount / sampleValues.length > 0.7) {
            dataType = 'Date';
          } else if (numericCount / sampleValues.length > 0.7) {
            dataType = 'Number';
          }
        }
        
        // Determine completeness color
        let completenessColor = '#ef4444';
        if (completeness >= 80) completenessColor = '#10b981';
        else if (completeness >= 50) completenessColor = '#f59e0b';
        
        html += `
          <tr>
            <td><strong>${header}</strong></td>
            <td>${dataType}</td>
            <td>${nonEmpty.length}</td>
            <td>${empty}</td>
            <td><span style="color: ${completenessColor};">${completeness}%</span></td>
            <td>${uniqueValues.size}</td>
          </tr>
        `;
      });
      
      dataQualityBody.innerHTML = html;
    }
    
    // Update time trends
    function updateTimeTrends() {
      // This would be implemented with a charting library
      // For now, we'll just show a placeholder
      const dateColumn = findDateColumn();
      
      if (dateColumn) {
        // Show time trends section
        document.getElementById('timeTrendsSection').style.display = 'block';
        
        // Placeholder for charts
        document.getElementById('dailyVolumeChart').innerHTML = `
          <div style="text-align: center; padding: 100px 20px; color: #94a3b8;">
            <i class="bi bi-bar-chart" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
            Daily volume chart would appear here with chart.js integration
          </div>
        `;
        
        document.getElementById('scoreTrendChart').innerHTML = `
          <div style="text-align: center; padding: 100px 20px; color: #94a3b8;">
            <i class="bi bi-graph-up" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>
            Score trend chart would appear here with chart.js integration
          </div>
        `;
      } else {
        document.getElementById('timeTrendsSection').style.display = 'none';
      }
    }
    
    // Update selected cell count
    function updateSelectedCount() {
      const selectedCountElement = document.getElementById('selectedCount');
      if (selectedCountElement) {
        selectedCountElement.textContent = `${selectedCells.size} ${selectedCells.size === 1 ? 'cell' : 'cells'}`;
      }
    }
    
    // Export as CSV
    function exportAsCsv() {
      if (csvData.length === 0) {
        showMessage('No data to export', 'error');
        return;
      }
      
      // Get delimiter for export
      let exportDelimiter = currentDelimiter;
      if (exportDelimiter === '\t') {
        exportDelimiter = '\t'; // Keep as tab
      }
      
      // Create CSV content
      let csvContent = currentHeaders.map(h => `"${h.replace(/"/g, '""')}"`).join(exportDelimiter) + '\n';
      
      csvData.forEach(row => {
        const rowValues = currentHeaders.map(header => {
          const value = row[header] || '';
          // Escape quotes and wrap in quotes if contains delimiter or quotes
          const escapedValue = value.replace(/"/g, '""');
          if (escapedValue.includes(exportDelimiter) || escapedValue.includes('"') || escapedValue.includes('\n') || escapedValue.includes('\r')) {
            return `"${escapedValue}"`;
          }
          return escapedValue;
        });
        csvContent += rowValues.join(exportDelimiter) + '\n';
      });
      
      const dataBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `exported_data_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
      
      URL.revokeObjectURL(url);
      showMessage(`CSV file downloaded with "${exportDelimiter === '\t' ? 'Tab' : exportDelimiter}" delimiter!`, 'success');
    }
    
    // Clear all data
    function clearData() {
      if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        csvData = [];
        filteredData = [];
        currentHeaders = [];
        selectedCells.clear();
        originalCsvText = '';
        dateRangeFilter = null;
        
        // Reset UI
        document.getElementById('fileName').textContent = '';
        document.getElementById('fileUploadArea').classList.remove('has-file');
        document.getElementById('fileInput').value = '';
        document.getElementById('delimiterControl').style.display = 'none';
        document.getElementById('reparseBtn').style.display = 'none';
        document.getElementById('exportCsvBtn').style.display = 'none';
        document.getElementById('clearDataBtn').style.display = 'none';
        document.getElementById('analyticsTabBtn').style.display = 'none';
        document.getElementById('dataTableCard').style.display = 'none';
        document.getElementById('tableToolbar').style.display = 'none';
        document.getElementById('analyticsToolbar').style.display = 'none';
        document.getElementById('tableContainer').innerHTML = '';
        document.getElementById('tableStats').innerHTML = '';
        document.getElementById('selectedCount').textContent = '0 cells';
        document.getElementById('analyticsRowCount').textContent = '0 rows';
        
        // Reset analytics tab
        document.getElementById('keyMetrics').innerHTML = '';
        document.getElementById('wordCloud').innerHTML = '';
        document.getElementById('scoreDistribution').innerHTML = '';
        document.getElementById('sentimentAnalysis').innerHTML = '';
        document.getElementById('topReviews').innerHTML = '';
        document.getElementById('dataQualityBody').innerHTML = '';
        document.getElementById('timeTrendsSection').style.display = 'none';
        
        // Switch back to data tab
        switchTab('dataTab');
        
        showMessage('All data cleared', 'success');
      }
    }
  </script>
</body>
</html>
